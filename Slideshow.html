<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dynamic slideshow</title>
    <style>
        body {
            margin: 0;
            background-color: black;
            overflow: hidden;
        }

        img#slideshow {
            display: block;
            margin: auto;
            max-width: 100vw;
            max-height: 100vh;
        }

        #watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-family: sans-serif;
            font-size: 1em;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        #watermark img {
            height: 120px;
            width: 120px;
        }

        #watermark span {
            white-space: pre-line;
        }

        #no-images {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: sans-serif;
            font-size: 2em;
            text-align: center;
            padding: 1em;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            display: none;
            z-index: 999;
        }
    </style>
</head>
<body>
    <img id="slideshow" src="" alt="Diaporama">
    <div id="no-images">Waiting for the first incoming photograph</div>

    <div id="watermark">
        <span id="watermark-text"></span>
        <img id="watermark-qr" src="" alt="QR Code">
    </div>

    <script>
        let config = {};
        let images = [];
        let current = 0;
        let updating = false;

        async function loadConfig() {
            const response = await fetch("config.json?ts=" + Date.now());
            config = await response.json();
        }

        function updateWatermark() {
            const watermarkDiv = document.getElementById("watermark");
            const textSpan = document.getElementById("watermark-text");
            const qrImg = document.getElementById("watermark-qr");

            if (config.watermarkText || config.watermarkQR) {
                watermarkDiv.style.display = "flex";

                if (config.watermarkText) {
                    textSpan.textContent = config.watermarkText + "\nhttps://tally.so/r/" + config.tally_form_id;
                }
                if (config.watermarkQR) {
                    qrImg.src = config.watermarkQR;
                }
            } else {
                watermarkDiv.style.display = "none";
            }
        }

        function updateNoImagesMessage() {
            const message = document.getElementById("no-images");
            const slideshow = document.getElementById("slideshow");

            if (images.length === 0) {
                message.style.display = "block";
                slideshow.style.display = "none";
            } else {
                message.style.display = "none";
                slideshow.style.display = "block";
            }
        }

        async function fetchImages() {
            try {
                updating = true;
                const response = await fetch(config.imageList + "?ts=" + Date.now());
                const newImages = await response.json();

                if (JSON.stringify(newImages) !== JSON.stringify(images)) {
                    images = newImages;
                    current = 0;
                    console.log("Images mises Ã  jour :", images);
                }

                updateNoImagesMessage();
            } catch (e) {
                console.error("Erreur lors du chargement des images :", e);
            } finally {
                updating = false;
            }
        }

        function showNextImage() {
            if (images.length > 0 && !updating) {
                const img = document.getElementById("slideshow");
                img.src = images[current];
                current = (current + 1) % images.length;
            }
        }

        async function startSlideshow() {
            await loadConfig();
            await fetchImages();
            updateWatermark();
            showNextImage();

            setInterval(showNextImage, config.intervalSlideshow);
            setInterval(fetchImages, config.intervalRefresh);
        }

        startSlideshow();
    </script>
</body>
</html>
